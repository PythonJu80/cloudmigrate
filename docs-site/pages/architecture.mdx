# Platform Architecture

Technical overview of CloudFabric's stack and infrastructure.

## Tech Stack

| Layer | Technology |
|-------|------------|
| Frontend | Next.js 14, React, TypeScript, Tailwind CSS, shadcn/ui |
| Canvas | React Flow (@xyflow/react) for diagrams and workflows |
| Backend | Next.js API Routes |
| Database | PostgreSQL with Prisma ORM |
| Graph DB | Neo4j for knowledge graph |
| Cache | Redis |
| Auth | NextAuth.js with credentials provider |
| AI | OpenAI API (GPT-4, text-embedding-3-small) |
| Cloud SDKs | AWS SDK v3, GCP, Azure, OCI |

## Database Schema

Key Prisma models:

### Tenant
Multi-tenant organization with:
- `plan` (FREE, PRO, ENTERPRISE)
- `bytesTransferred` / `bytesLimit` for quota
- `awsRoleArn`, `awsExternalId` for cross-account
- `stripeCustomerId`, `stripeSubId` for billing
- `companyWebsite`, `companyContext` for RAG

### User
- `email`, `passwordHash`
- `role` (SUPERUSER, ADMIN, USER, VIEWER)
- `emailVerified` timestamp
- Belongs to one Tenant

### Transfer
- `fileName`, `fileSize`, `mimeType`
- `s3Key`, `bucketId`
- `status` (PENDING, UPLOADING, COMPLETED, FAILED, CANCELLED)

### Secret
Encrypted credential storage:
- `key` (e.g., AWS_ACCESS_KEY_ID)
- `value` (AES-256-GCM encrypted)
- Scoped to Tenant

### CloudFlow
Workflow definitions:
- `name`, `description`
- `nodes`, `edges` (JSON)
- `schedule` (cron expression)
- `isActive`

### Architecture
Saved diagrams:
- `name`, `description`
- `nodes`, `edges` (JSON)
- `cloudformationTemplate` (generated)

### AlertRule / AlertIncident
Monitoring alerts:
- `metric`, `condition`, `threshold`
- Incidents with status (OPEN, ACKNOWLEDGED, RESOLVED)

### KnowledgeChunk
RAG embeddings:
- `title`, `content`
- `embedding` (vector)
- `source` (global or company-specific)

## Docker Services

Development environment via docker-compose:

| Service | Port | Purpose |
|---------|------|---------|
| dev | 6080 | Next.js app |
| postgres | 6070 | PostgreSQL database |
| redis | 4379 | Cache and queues |
| neo4j | 6085/6086 | Graph database |
| prometheus | 6090 | Metrics collection |
| grafana | 6091 | Metrics visualization |
| yace | 6092 | AWS CloudWatch exporter |
| docs | 6081 | Documentation site |

## Authentication

NextAuth.js with:
- Credentials provider (email/password)
- bcrypt password hashing
- JWT session strategy
- Email verification flow via Resend API

## Encryption

Secrets encrypted with AES-256-GCM:
- Key derived from `NEXTAUTH_SECRET`
- IV stored with ciphertext
- Auth tag for integrity

## AWS Integration

Uses AWS SDK v3 clients:
- S3Client for storage operations
- CloudWatchClient for metrics
- CloudFormationClient for deployments
- CostExplorerClient for billing
- HealthClient for service status
- EC2Client for instance data

Supports cross-account access via STS AssumeRole.

## AI Integration

### CloudGPT
- System prompt in `lib/prompts/data-assistant.ts`
- Structured JSON responses
- RAG context from KnowledgeChunk table

### Architecture Agent
- System prompts in `lib/architecture/agents/`
- Knows AWS Well-Architected Framework
- Generates node/edge JSON for React Flow

### Workflow Agent
- Generates CloudFlow node configurations
- Understands available node types from registry

## Knowledge Graph (Neo4j)

Stores:
- Cloud resources as nodes
- Relationships (depends_on, connects_to)
- Tenant isolation via tenantId property

Graph algorithms available:
- PageRank
- Community detection
- Path finding

## File Structure

```
src/
├── app/                 # Next.js App Router pages
│   ├── api/            # API routes
│   ├── migrate/        # CloudMigrate page
│   ├── cloudflow/      # CloudFlow page
│   ├── architecture/   # CloudArch page
│   ├── monitoring/     # CloudWatch page
│   └── chat/           # CloudGPT page
├── components/          # React components
├── lib/                 # Business logic
│   ├── aws/            # AWS SDK wrappers
│   ├── cloudflow/      # Workflow engine
│   ├── architecture/   # Diagram logic
│   └── prompts/        # AI system prompts
└── store/              # Zustand stores
```
