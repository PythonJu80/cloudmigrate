# API Reference

CloudFabric exposes Next.js API routes. All routes require session authentication via NextAuth.

## Authentication

Routes use `getServerSession(authOptions)` to verify the user. Unauthenticated requests return 401.

## API Routes

### Buckets

**GET /api/buckets**

List S3 buckets from AWS account.

Response:
```json
{
  "buckets": [{ "name": "my-bucket", "creationDate": "2024-01-01T00:00:00Z" }],
  "savedBuckets": [{ "id": "...", "name": "my-bucket", "region": "us-east-1" }]
}
```

**POST /api/buckets**

Save a bucket configuration.

### Upload

**POST /api/upload**

Request presigned URL for S3 upload.

Request:
```json
{
  "fileName": "file.txt",
  "fileSize": 1024,
  "bucketName": "my-bucket",
  "prefix": "uploads/"
}
```

Response:
```json
{
  "presignedUrl": "https://s3.amazonaws.com/...",
  "transferId": "...",
  "s3Key": "uploads/file.txt"
}
```

### Browser

**GET /api/browser?bucket=name&prefix=path/**

List objects in S3 bucket.

**GET /api/browser/download?bucket=name&key=path/file.txt**

Get presigned download URL.

### History

**GET /api/history**

List transfer history with pagination.

Query params: `status`, `limit`, `offset`

### Stats

**GET /api/stats**

Get transfer statistics.

Response:
```json
{
  "totalTransfers": 100,
  "completedTransfers": 95,
  "failedTransfers": 5,
  "bytesTransferred": 1073741824,
  "bytesLimit": 5368709120,
  "recentTransfers": [...]
}
```

### Monitoring

**GET /api/monitoring/metrics**

Get AWS CloudWatch metrics, costs, and health events.

### Chat

**POST /api/chat**

Send message to CloudGPT.

Request:
```json
{
  "message": "Show me failed transfers",
  "threadId": "optional-thread-id"
}
```

**GET /api/chat/threads**

List chat threads.

**GET /api/chat/threads/:threadId**

Get thread with messages.

**DELETE /api/chat/threads/:threadId**

Delete a thread.

### CloudFlow

**GET /api/cloudflow**

List workflows.

**POST /api/cloudflow**

Create workflow.

Request:
```json
{
  "name": "My Workflow",
  "nodes": [...],
  "edges": [...],
  "schedule": "0 0 * * *"
}
```

**GET /api/cloudflow/:flowId**

Get workflow by ID.

**PUT /api/cloudflow/:flowId**

Update workflow.

**DELETE /api/cloudflow/:flowId**

Delete workflow.

**POST /api/cloudflow/:flowId/run**

Execute workflow.

**GET /api/cloudflow/:flowId/executions**

List workflow executions.

### Architecture

**GET /api/architecture**

List saved architectures.

**POST /api/architecture**

Save architecture.

**GET /api/architecture/:archId**

Get architecture by ID.

**DELETE /api/architecture/:archId**

Delete architecture.

**POST /api/architecture/:archId/deploy**

Deploy architecture via CloudFormation.

**POST /api/architecture/generate**

AI-generate architecture from prompt.

### Alerts

**GET /api/alerts/rules**

List alert rules.

**POST /api/alerts/rules**

Create alert rule.

**GET /api/alerts/incidents**

List alert incidents.

**PUT /api/alerts/incidents/:id**

Update incident (acknowledge/resolve).

### Config

**GET /api/config**

Get tenant configuration.

**POST /api/config**

Save AWS credentials.

**POST /api/config/test**

Test AWS connection.

**POST /api/config/providers**

Save multi-cloud provider credentials.

**POST /api/config/providers/test**

Test provider connection.

**POST /api/config/openai**

Save OpenAI API key.

### Settings

**GET /api/settings/company-knowledge**

Get company knowledge base.

**POST /api/settings/company-knowledge**

Scrape and save company website.

### Graph (Neo4j)

**GET /api/graph**

Get knowledge graph data.

**POST /api/graph/nodes**

Create graph node.

**POST /api/graph/algorithms**

Run graph algorithm (PageRank, etc.).

### Billing

**GET /api/billing**

Get billing status.

**POST /api/billing/checkout**

Create Stripe checkout session.

**POST /api/billing/portal**

Create Stripe customer portal session.

## Error Responses

All errors return:
```json
{
  "error": "Error message"
}
```

With appropriate HTTP status codes:
- 400 - Bad request
- 401 - Unauthorized
- 403 - Forbidden (e.g., quota exceeded)
- 404 - Not found
- 500 - Server error
