services:
  postgres:
    image: pgvector/pgvector:pg16
    restart: unless-stopped
    ports:
      - "6070:5432"
    environment:
      - POSTGRES_USER=cloudmigrate
      - POSTGRES_PASSWORD=cloudmigrate2025
      - POSTGRES_DB=cloudmigrate
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cloudmigrate"]
      interval: 5s
      timeout: 5s
      retries: 5
    profiles:
      - dev

  dev:
    image: node:20-slim
    restart: unless-stopped
    working_dir: /app
    ports:
      - "6080:3000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=postgresql://cloudmigrate:cloudmigrate2025@postgres:5432/cloudmigrate
      - NEXTAUTH_URL=http://localhost:6080
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}
      - STRIPE_PRO_PRICE_ID=${STRIPE_PRO_PRICE_ID:-}
      - STRIPE_ENTERPRISE_PRICE_ID=${STRIPE_ENTERPRISE_PRICE_ID:-}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=cloudmigrate2025
      - REDIS_URL=redis://redis:6379
      - NEXT_PUBLIC_GRAFANA_URL=http://localhost:6091
      - NEXT_PUBLIC_CRAWL4AI_URL=http://localhost:1021
    volumes:
      - .:/app
      - node_modules:/app/node_modules
      - ${HOME}:/user-home:ro  # Mount user's home directory (read-only)
    command: bash -c "apt-get update && apt-get install -y openssl && npm install && npx prisma generate && npx prisma db push --skip-generate && npm run dev"
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_started
      redis:
        condition: service_started
      crawl4ai:
        condition: service_started
    profiles:
      - dev

  # Redis - Job queues, caching, event bus
  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - "4379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - dev

  # Neo4j Graph Database - Multi-tenant knowledge graphs
  neo4j:
    image: neo4j:5.15.0-community
    restart: unless-stopped
    ports:
      - "6085:7474"  # Browser UI
      - "6086:7687"  # Bolt protocol
    environment:
      - NEO4J_AUTH=neo4j/cloudmigrate2025
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*,gds.*
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    profiles:
      - dev

  # # Prometheus - Metrics collection (DISABLED)
  # prometheus:
  #   image: prom/prometheus:v2.47.0
  #   restart: unless-stopped
  #   ports:
  #     - "6090:9090"
  #   volumes:
  #     - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus_data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--web.enable-lifecycle'
  #   profiles:
  #     - dev

  # # Grafana - Metrics visualization (DISABLED)
  # grafana:
  #   image: grafana/grafana:10.2.0
  #   restart: unless-stopped
  #   ports:
  #     - "6091:3000"
  #   environment:
  #     - GF_SECURITY_ADMIN_USER=admin
  #     - GF_SECURITY_ADMIN_PASSWORD=cloudmigrate2025
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #     - GF_AUTH_ANONYMOUS_ENABLED=true
  #     - GF_AUTH_ANONYMOUS_ORG_ROLE=Viewer
  #     - GF_SECURITY_ALLOW_EMBEDDING=true
  #     - GF_SERVER_ROOT_URL=http://localhost:6091
  #   volumes:
  #     - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
  #     - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
  #     - grafana_data:/var/lib/grafana
  #   depends_on:
  #     - prometheus
  #   profiles:
  #     - dev

  # # CloudWatch Exporter (YACE) - AWS metrics to Prometheus (DISABLED)
  # yace:
  #   image: ghcr.io/nerdswords/yet-another-cloudwatch-exporter:v0.55.0
  #   restart: unless-stopped
  #   ports:
  #     - "6092:5000"
  #   volumes:
  #     - ./monitoring/yace-config.yml:/tmp/config.yml:ro
  #   environment:
  #     - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
  #     - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
  #     - AWS_REGION=${AWS_REGION:-us-east-1}
  #   command:
  #     - '--config.file=/tmp/config.yml'
  #     - '--listen-address=:5000'
  #   profiles:
  #     - dev

  # # Documentation site (Nextra) (DISABLED)
  # docs:
  #   image: node:20-slim
  #   restart: unless-stopped
  #   working_dir: /app
  #   ports:
  #     - "6081:3001"
  #   volumes:
  #     - ./docs-site:/app
  #     - docs_node_modules:/app/node_modules
  #   command: bash -c "npm install && npm run dev"
  #   profiles:
  #     - dev

  # Crawl4AI RAG API - Web crawling and knowledge base
  crawl4ai:
    build:
      context: ./mcp-crawl4ai-rag
      dockerfile: Dockerfile
    ports:
      - "1021:1021"
    environment:
      - TRANSPORT=sse
      - HOST=0.0.0.0
      - PORT=1021
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - MODEL_CHOICE=gpt-4o-mini
      - USE_CONTEXTUAL_EMBEDDINGS=true
      - USE_HYBRID_SEARCH=true
      - USE_AGENTIC_RAG=true
      - USE_RERANKING=true
      - USE_KNOWLEDGE_GRAPH=true
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=cloudmigrate2025
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=cloudmigrate
      - DB_PASSWORD=cloudmigrate2025
      - DB_NAME=cloudmigrate
      - REDIS_URL=redis://redis:6379
      - MAX_CONCURRENT_CRAWLS_PER_TENANT=5
      - MAX_CRAWLS_PER_HOUR_PER_TENANT=20
      - JOB_EXPIRY_HOURS=24
      - DB_POOL_SIZE=20
      - MAX_PARALLEL_BATCHES=4
    volumes:
      - crawl4ai_data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
      neo4j:
        condition: service_started
      redis:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1021/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    profiles:
      - dev

  cloudmigrate:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "6080:3000"
    environment:
      - DATABASE_URL=file:/app/data/dev.db
      - NEXTAUTH_URL=http://localhost:6080
      - NEXTAUTH_SECRET=your-super-secret-key-change-in-production
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
    volumes:
      - cloudmigrate-data:/app/data
    restart: unless-stopped
    profiles:
      - prod


  # Learning Agent - AI-powered scenario generator for CloudAcademy
  learning-agent:
    build:
      context: ./learning_agent
      dockerfile: Dockerfile
    ports:
      - "1027:1027"
    env_file:
      - ./learning_agent/.env
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:1027/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    profiles:
      - dev

  # CloudAcademy - Cloud Architecture Training Platform
  cloud-academy:
    image: node:20-slim
    restart: unless-stopped
    working_dir: /app
    ports:
      - "6060:6060"
    env_file:
      - ./cloud-academy/.env
    environment:
      - PORT=6060
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
    volumes:
      - ./cloud-academy:/app
      - cloud_academy_node_modules:/app/node_modules
      - ./prisma:/app/prisma
    command: bash -c "apt-get update && apt-get install -y openssl && npm install && npx prisma generate && npm run dev"
    depends_on:
      - learning-agent
    profiles:
      - dev

volumes:
  postgres_data:
  cloudmigrate-data:
  node_modules:
  docs_node_modules:
  neo4j_data:
  neo4j_logs:
  prometheus_data:
  grafana_data:
  redis_data:
  crawl4ai_data:
  cloud_academy_node_modules: